<!DOCTYPE html>

<html>

<head>
    <title>Portal: It's MyGO!!!!!</title>
    <meta charset="utf-8">
    <link rel="Shortcut Icon" href="./assets/ico/RanaLogo.png" type="image/x-icon" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scale=no">
    <link rel="stylesheet" type="text/css" href="./assets/style/base.css">
    <link rel="stylesheet" type="text/css" href="./assets/style/start.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Noto+Serif+SC:wght@200..900&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Noto+Sans+SC:wght@100..900&display=swap"
        rel="stylesheet">

    <style>
        body.prev {
            background-color: black;
        }
    </style>
</head>

<body class="prev">
    <div class="splash hide">
        <div class="disclaimer">
            <div class="fanmade">
                <div>本作为同人二次创作作品，设定差异等还请理解。</div>
                <div>This is a fan-made derivative work, please understand the differences in settings, etc.</div>
                <div>このゲームは二次創作作品です。設定の差異等にご注意ください。</div>
            </div>
            <br />
            <div class="copyright">
                <div>©2024 光圈科技爱猫TV, 在MIT协议下开放源代码。</div>
                <div>Valve, the Valve logo, Half-Life, the Half-Life
                    logo, the Lambda logo, Steam, the Steam logo, Team Fortress, the Team Fortress logo, Opposing Force,
                    Day of Defeat, the Day of Defeat logo, Counter-Strike, the Counter-Strike logo, Source, the Source
                    logo, Counter-Strike: Condition Zero, Portal, the Portal logo, Dota, the Dota 2 logo, and Defense of
                    the Ancients are trademarks and/or registered trademarks of Valve Corporation. All other trademarks
                    are property of their respective owners.
                </div>
                <div>
                    当プロジェクトに関する著作物に含まれるキャラクターの名称、形状、デザイン、映像、音声、
                    ストーリーおよび世界観、ロゴ、音楽その他当プロジェクトの構成素材
                    に関する著作権等の権利は、株式会社ブシロードまたは当社に権利を許諾した第三者が有しているため、
                    当社の事前の許可なく、複製、翻案、翻訳、頒布、
                    インターネット上でのアップロードその他の方法で利用することはできません。

                    本コンテンツに新たな創作性を加えお客様ご自身が制作した著作物を、
                    個人により営利を目的としない場合に限り、制作、展示、頒布および公開することができます。
                </div>
            </div>
        </div>
        <div class="logo hide">
            <img src="./assets/imgs/Tidbits/logo2.png">
        </div>
    </div>
    <div class="menu">
        <div class="title">
            <div class="vertical">
                <div>传</div>
                <div>送</div>
            </div>
            <div class="horizontal">
                <div class="text">
                    乐奈与抹茶奇境
                </div>
            </div>
        </div>
        <div class="button-container">
            <div class="button" id="start">开始新游戏</div>
            <div class="button" id="load">加载存档</div>
            <div class="button" id="achievement">成就</div>
            <div class="button" id="exit">退出</div>
        </div>
        <div class="side">
            Portal! It's MyGO!!!!!
        </div>
    </div>

    <div class="save hide" id="save-load">
        <div class="save-container"></div>
        <div class="button-container">
            <div class="button" id="save-back">返回</div>
        </div>
    </div>

    <div class="achievementDisp hide">
        <div class="achievement-container">
            <div class="title">成就</div>
            <div class="list"></div>
        </div>
        <div class="button-container">
            <div class="button" id="achievement-back">返回</div>
        </div>
    </div>

    <div class="transition hidden">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>

    <div id="resource" style="display: none;"></div>

    <script type="text/javascript" src="script/utils/Electron.js"></script>
    <script type="text/javascript" src="script/utils/Store.js"></script>
    <script type="text/javascript" src="script/utils/Auth.js"></script>
    <script type="text/javascript" src="script/utils/Save.js"></script>
    <script type="text/javascript" src="script/utils/Vector.js"></script>
    <script type="text/javascript" src="script/utils/Hitbox.js"></script>
    <script type="text/javascript" src="script/utils/AchievementDisp.js"></script>
    <script type="text/javascript" src="script/Managers/AchievementManager.js"></script>
    <script type="text/javascript" src="script/Managers/DataManager.js"></script>
    <script type="text/javascript" src="script/Managers/SoundManager.js"></script>

    <script type="text/javascript">
        const slideIn = () => {
            const transition = document.querySelector(".transition");
            transition.classList.remove("hidden");
            transition.classList.add("slideIn");
            setTimeout(() => {
                transition.classList.add("hidden");
                transition.classList.remove("slideIn");
            }, 1800);
        };

        const slideOut = () => {
            const transition = document.querySelector(".transition");
            transition.classList.remove("hidden");
            transition.classList.add("slideOut");
            setTimeout(() => {
                transition.classList.add("hidden");
                transition.classList.remove("slideOut");
            }, 1800);
        };

        const showSplash = () => {
            // 辅助延迟函数
            const delay = (ms) => {
                return new Promise((resolve) => setTimeout(resolve, ms));
            }
            return new Promise(async (resolve) => {
                const splash = document.querySelector(".splash");
                const disclaimer = document.querySelector(".disclaimer");
                const logo = document.querySelector(".logo");
                const main = document.querySelector(".menu");

                splash.addEventListener("click", async () => {
                    disclaimer.classList.add("fadeOut2000");
                    await delay(2000);
                    disclaimer.classList.remove("fadeOut2000");
                    disclaimer.classList.add("hide");
                    logo.classList.add("fadeIn2000");
                    logo.classList.remove("hide");
                    await delay(2000);
                    logo.classList.remove("fadeIn2000");
                    await delay(1700);
                    document.body.classList.remove("prev");
                    splash.classList.add("fadeOut2000");
                    await delay(2000);
                    splash.classList.add("hide");
                    splash.classList.remove("fadeOut2000");
                    resolve();
                }, { once: true });

                main.classList.add("hide");
                disclaimer.classList.remove("hide");
                disclaimer.classList.add("fadeIn2000");
                splash.classList.remove("hide");
                await delay(2000);
                disclaimer.classList.remove("fadeIn2000");
            });
        }

        window.onload = async () => {
            await Electron.init();
            window.$store = new Store();
            Store.remove("toLoad");

            window.$game = {
                dataManager: new DataManager(),
                soundManager: new SoundManager("index"),
            }

            window.$game.soundManager.isRandomBGM = false;
            window.$game.soundManager.bgmsFormal = [
                new Audio("./assets/audios/bgms/ドピュッシー「亜麻色の髪の乙女」.mp3"),
                new Audio("./assets/audios/bgms/ショパン「雨だれ」.mp3"),
            ]
            await window.$game.soundManager.load();

            if (!sessionStorage.getItem("bootup"))
                await showSplash();
            sessionStorage.setItem("bootup", "true");

            const achievementDisp = new AchievementDisp(
                document.querySelector(".achievement-container > .list")
            );

            const load = new Load((data) => {
                Store.set("toLoad", JSON.stringify(data));
                window.location.href = `./game.html?${window.$store.encode()}`;
            })

            document.querySelector(".menu").classList.remove("hide");
            slideIn();
            if (!Auth.isAuthenticated()) {
                Auth.toLogin();
            }

            let canScroll = false;

            const achievementManager = new AchievementManager();

            document.querySelector("#start").addEventListener("click", () => {
                window.location.href = `./game.html?${window.$store.encode()}`;
            });
            document.querySelector("#load").addEventListener("click", () => {
                slideOut();
                setTimeout(() => {
                    document.querySelector(".menu").classList.add("hide");
                    document.querySelector(".save").classList.remove("hide");
                    load.build();
                    slideIn();
                }, 1800);
            });
            document.querySelector("#save-back").addEventListener("click", () => {
                slideOut();
                setTimeout(() => {
                    document.querySelector(".save").classList.add("hide");
                    document.querySelector(".save-container").innerHTML = "";
                    document.querySelector(".menu").classList.remove("hide");
                    slideIn();
                }, 1800);
            });
            document.querySelector("#achievement").addEventListener("click", () => {
                slideOut();
                if (!Store.get("achievements") || !AchievementManager.getAll().length) {
                    achievementManager.refresh();
                }
                setTimeout(() => {
                    document.querySelector(".menu").classList.add("hide");
                    document.querySelector(".achievementDisp").classList.remove("hide");
                    achievementDisp.disp();
                    slideIn();
                    canScroll = true;
                }, 1800);
            });
            document.querySelector("#achievement-back").addEventListener("click", () => {
                slideOut();
                canScroll = false;
                setTimeout(() => {
                    document.querySelector(".achievementDisp").classList.add("hide");
                    document.querySelector(".achievement-container > .list").innerHTML = "";
                    document.querySelector(".menu").classList.remove("hide");
                    slideIn();
                }, 1800);
            });
            document.querySelector("#exit").addEventListener("click", () => {
                Auth.logout();
                Auth.toLogin();
            });

            document.querySelector(".achievementDisp").addEventListener("scroll", (e) => {
                if (canScroll) {
                    let offsetY = e.target.scrollLeft * Math.tan(10 / 180 * Math.PI)
                    document.querySelector(".achievementDisp").style.setProperty("--offsetY", `${offsetY}px`);
                }
            })
            await achievementManager.load()
        }
    </script>
</body>

</html>